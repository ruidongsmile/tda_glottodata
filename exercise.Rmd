---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(glottospace)

## Plot point data:
glottomap(continent = "South America", color = "isolate")
```

```{r}
## Filter by continent
glottopoints <- glottofilter(continent = "South America")
# Interpolate points to polygons:
glottopols <- glottospace(glottopoints, method = "voronoi")
# Plot polygon data:
glottomap(glottodata = glottopols, color = "family_size_rank")
```

```{r}
glottodata <- glottoget("demodata", meta = TRUE)
head(glottodata)
```

```{r}
glottodist(glottodata)
```

```{r}
glottodata$structure$type
```




```{r}
?glottodist
```


```{r}
library(sf)
```


```{r}
wals <- glottoget("wals")
colnames(wals)
```

```{r}
"1A" %in% colnames(wals)
```

```{r}
length(wals[0,])
length(st_drop_geometry(wals[0,]))
```

```{r}
"Brazil" %in% st_drop_geometry(wals[,"country"])[,1]
```

```{r}
wals_sam <- subset(wals, continent == "South America")
```

```{r}
View(wals_sam)
```


```{r}
wals_sam
```


```{r}
count.na <- function (dataset, feature.name) {
  num.features <- length(st_drop_geometry(dataset))
  return(sum(is.na(dataset[[feature.name]])) / nrow(dataset))
  
}
```

```{r}
feature_names <- colnames(wals_sam)[-c(1, 194:208)]
counts <- c()
for (x in feature_names) {
  counts <- append(counts, count.na(wals_sam, x))
}
sum(counts < 0.5)
result.val <- t(as.matrix(counts[counts<0.5]))
feature_names[which(counts<0.5)]

colnames(x) <- feature_names[which(counts<0.5)]
x
```


```{r}
# return a 1-dim matrix containing the feature names with NA values less than the threshold a
select.features <- function(dataset, feature_names, a) {
  counts <- c()
  for (x in feature_names) {
    counts <- append(counts, count.na(wals_sam, x))
  }
  result <- t(as.matrix(counts[counts<0.5]))
  colnames(result) <- feature_names[which(counts<0.5)]
  
  return(result)
}
select.features(wals_sam, feature_names, 0.5)
```

```{r}
library(dplyr)
data <- select(wals_sam, 'glottocode', '81A', '82A', '83A', '86A', '129A')
data
```




```{r}
unique(st_drop_geometry(wals[,"country"]))[,1]
```


```{r}
glottodata <- glottoget("demodata", meta = TRUE)

glottodata
glottodist <- glottodist(glottodata = glottodata)
glottodist
```








```{r}
library(sf)      
library(terra)
plot(st_geometry(wals_sam))

```



```{r}
#install.packages(c("FactoMineR", "factoextra"))
```

```{r}
library("tidyverse")
library("FactoMineR")
library("factoextra")
```



```{r}
library(FactoMineR)

data.obj <- st_drop_geometry(data)
# data.obj[is.na(data.obj)] <- "unknown"

data.famd <- FAMD(data.obj, graph=FALSE)

data.famd
```
```{r}
data.obj
```


```{r}
dim(data.famd$eig)
```

```{r}
data.famd$var
```

```{r}
data.famd$quali.var
```


```{r}
hamming_dist <- function (df){ 
  num.row <- nrow(df)
  dist.mat <- matrix(NA, nrow=num.row, ncol=num.row)
  
  for (i in 1:num.row) {
    for (j in 1:num.row) {
      dist.mat[i, j] <- sum(df[i,] != df[j,])
    }
  }
  return(dist.mat / num.row)
}
```

```{r}
data.hamming.distance <- hamming_dist(data.obj)
```

```{r}
library(TDAstats)
```

```{r}
dist.phom <- calculate_homology(data.hamming.distance, format = "distmat")
```

```{r}
plot_barcode(dist.phom)
```

```{r}
plot_persist(dist.phom)
```

```{r}
library(nomclust)
data.obj.g1 <- good1(data.obj)
data.obj.g1
```

```{r}
dist.g1.phom <- calculate_homology(data.obj.g1, format = "distmat")
plot_persist(dist.g1.phom)
```

```{r}
plot_barcode(dist.g1.phom)
```


```{r}
dist.lin.phom <- calculate_homology(lin(data.obj), format = "distmat")
plot_persist(dist.lin.phom)
```


```{r}
st_geometry(data)
```

```{r}
data.coord <- st_coordinates(data)
```


```{r}
data.local <- data.frame(data.coord)
```

```{r}
f <- ggplot(data.frame(data.coord), aes(x=X, y=Y),)
f +
  geom_point(color="red", alpha=0.4, size=2)
```

```{r}
glottodist(data)
```


```{r}
data.local
```

```{r}
data.local.phom <- calculate_homology(data.local, dim=1)
```

```{r}
plot_barcode(data.local.phom)
```

```{r}
plot_persist(data.local.phom)
```
```{r}
?glottocreate
?hausdorff_dist
```

```{r}
glottodata <- glottoget("demodata", meta = TRUE)
glottodist <- glottodist(glottodata = glottodata)
```
```{r}
glottodist
```


```{r}
glottodata
```


```{r}
glottodist
```

```{r}
plot_barcode(calculate_homology(glottodist))
```


```{r}
glottodist.phom <- calculate_homology(glottodist)
plot_barcode(glottodist.phom)
```

```{r}
structure <- glottocreate_structuretable(varnames = c("81A", "82A", "83A", "86A", "129A"))
```

```{r}
my.glottodata <- glottocreate_addtable(data.obj, structure, name="structure")
```

```{r}
length(my.glottodata)
```
```{r}
?glottocreate
```

```{r}
glottodist(my.glottodata)
```

```{r}
??tibble::column_to_rownames
```


```{r}
id <- "glottocode"
tibble::column_to_rownames(my.glottodata, id)
```

```{r}
rownames(as.data.frame(my.glottodata)) <- 
  my.glottodata[[id]]

my.glottodata[[id]]
```


```{r}
glottodata[[4]]
```

```{r}
class(glottoget("wals"))
```

```{r}
?glottoconvert
```


```{r}
glottodist(glottoconvert(data.obj, var=c("81A", "82A", "83A", "86A", "129A")))
```

```{r}
glottodist(my.glottodata)
```

```{r}
my.glottodata <- glottoclean(my.glottodata)
structure <- my.glottodata[["structure"]]
my.glottodata <- glottosimplify(my.glottodata)
duplo <- sum(duplicated(my.glottodata) | duplicated(my.glottodata, fromLast = TRUE))
duplo


tibble::column_to_rownames(my.glottodata, "glottocode")
```

```{r}
my.glottodata
```
```{r}
rownames(my.glottodata)
```

```{r}
length(my.glottodata$glottocode)
```

```{r}
length(unique(my.glottodata$glottocode))
```



```{r}
glottodata <- glottoclean(glottodata)
structure <- glottodata[["structure"]]
glottodata <- glottosimplify(glottodata)

tibble::column_to_rownames(glottodata, id)
```

```{r}
glottodata
```


```{r}
?tibble::column_to_rownames
```



```{r}
glottodist(glottoget("wals"))
```

```{r}
?glottodist
```


```{r}
glottoget("glottolog")
```


```{r}
glottodist(my.glottodata)
```



```{r}
glottodata
```


```{r}
colnames(gd[["glottodata"]])
```

```{r}
?glottocreate
```

```{r}
data.obj
```


```{r}
?is_list
glottocheck_hasmeta <- glottocheck_hasstructure <- function(glottodata){
  any(is_list(glottodata)) & any(names(glottodata) %in% "structure")
}

glottocheck_hasstructure(my.glottodata)


```



```{r}
glottocheck(my.glottodata)
```


```{r}
glottodata
```

```{r}
glottodist(my.glottodata)
```

```{r}
my.glottodata
```

```{r}
glottodata[c(1,2)]
```


```{r}
glottodist(glottodata[c(1,2)])
```


```{r}
?cluster::daisy
```

```{r}
?rep.int
```



```{r}
mtcars_tbl <- rownames_to_column(mtcars, var = "car")
mtcars_tbl
```

```{r}
length(wals$glottocode)
```

```{r}
wals.tb <- table(wals$glottocode)
wals.tb[wals.tb != 1]
```

```{r}
st_drop_geometry(wals[wals$glottocode == "adyg1241",])
```


```{r}
gtlog <- glottoget("glottolog")
st_drop_geometry(gtlog)
```
```{r}
wals.new <- st_drop_geometry(glottoget("wals", download = TRUE))
```

```{r}
length(wals.new$glottocode)
```

```{r}
length(unique(wals.new$glottocode))
```

```{r}
wals.new
```


```{r}
wals.new[wals.new$glottocode=="adyg1241",]
```

```{r}
my.glottodata <- my.glottodata[gtd.unique, ]
```


```{r}
glottodist(my.glottodata)
```






```{r}
structure <- glottocreate_structuretable(varnames = c("81A", "82A", "83A", "86A", "129A"))
```

```{r}
gtd.unique <- match(unique(data.obj$glottocode), data.obj$glottocode)
data.obj.unique <- data.obj[gtd.unique, ]
```


```{r}
my.glottodata <- glottocreate_addtable(data.obj.unique, structure, name="structure")
```


```{r}
glottodist(my.glottodata)
```

```{r}
my.glottodata
```


```{r}
tibble::column_to_rownames(my.glottodata, "glottodata")
```

```{r}
glottodata
```

```{r}
weights <- as.numeric(structure$weight)
weights

my.glottodata <- glottoclean(my.glottodata)
structure <- my.glottodata[["structure"]]
my.glottodata <- glottosimplify(my.glottodata)

cluster::daisy(x = my.glottodata, metric = "gower",
                         type = list(symm = symm, asymm = asymm, ordratio = ordratio, logratio = logratio),
                         weights = weights)

structure$type

symm <- which(structure$type == "symm")
asymm <- which(structure$type == "asymm")
numer <- which(structure$type == "numeric")
fact <- which(structure$type == "factor")
ordfact <- which(structure$type == "ordered")
ordratio <- which(structure$type == "ordratio")
logratio <- which(structure$type == "logratio")

cluster::daisy(my.glottodata, metric = "gower")

my.glottodata
```

```{r}
my.glottodata
```

```{r}
glottodist(glottodata)
```

```{r}

```


```{r}
?cluster::daisy
```

```{r}
data(agriculture)
class(my.glottodata)
```

